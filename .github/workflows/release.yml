name: Release
permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: 0.15.2
      - name: Run Tests
        run: zig build test

  bench:
    name: Run Benchmarks
    needs: test
    runs-on: ubuntu-latest
    outputs:
      bench_output: ${{ steps.run_bench.outputs.bench_output }}
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: 0.15.2
      - name: Run Benchmarks
        id: run_bench
        run: |
          # Run benchmarks (generates benchmark-results.md)
          zig build bench || true
          
          # Prepare output for release body from the generated markdown file
          echo "bench_output<<EOF" >> $GITHUB_OUTPUT
          if [ -f benchmark-results.md ]; then
            cat benchmark-results.md >> $GITHUB_OUTPUT
          else
            echo "No benchmark table found." >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

  build-library:
    name: Build Library (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-windows
          - x86-windows
          - x86_64-linux
          - x86-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos
          - x86_64-freestanding
          - x86-freestanding
          - aarch64-freestanding
          - riscv64-freestanding
          - arm-freestanding
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v1
        with:
          version: 0.15.2
      
      - name: Build Library
        run: zig build -Doptimize=ReleaseSafe -Dtarget=${{ matrix.target }}

      - name: Prepare Release Artifacts
        run: |
          mkdir -p release
          if [[ "${{ matrix.target }}" == *"windows"* ]]; then
            # Copy windows static lib
            cp zig-out/lib/args.lib release/args-${{ matrix.target }}.lib || true
          else
            # Copy unix static lib
            cp zig-out/lib/libargs.a release/libargs-${{ matrix.target }}.a || true
          fi
          # Only library artifacts are prepared for upload

      - name: Upload Release Artifacts
        run: |
          # Upload all prepared artifacts to the GitHub Release
          gh release upload "${{ github.event.release.tag_name }}" release/* --clobber || true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  update-release:
    name: Update Release Description
    needs: [test, bench]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Release URL
        id: get_url
        run: echo "url=https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz" >> $GITHUB_OUTPUT

      - uses: mlugg/setup-zig@v1
        with:
          version: 0.15.2

      - name: Calculate Hash
        id: calc_hash
        run: |
          zig fetch --save ${{ steps.get_url.outputs.url }}
          # Extract hash from build.zig.zon (it's updated by zig fetch)
          HASH=$(grep '.hash =' build.zig.zon | cut -d '"' -f 2)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Update Release Body
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ${{ github.event.release.body }}

            ### Option A ‚Äî Automatic (Recommended)

            Run this to install the dependency and automatically save the hash:

            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            After running, Zig updates your `build.zig.zon` with something like:

            ```zig
            .dependencies = .{
                .args = .{
                    .url = "https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz",
                    .hash = "${{ steps.calc_hash.outputs.hash }}",
                },
            },
            ```

            ### Option B ‚Äî Manual

            ```bash
            zig fetch --hash https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            Copy that hash into:

            ```zig
            .hash = "<your_hash_here>" // which is ${{ steps.calc_hash.outputs.hash }}
            ```

            ## ‚¨áÔ∏è Downloads (Prebuilt Library)

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Windows | x86_64 | [args-x86_64-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/args-x86_64-windows.lib) |
            | Windows | x86 | [args-x86-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/args-x86-windows.lib) |
            | Linux | x86_64 | [libargs-x86_64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-x86_64-linux.a) |
            | Linux | x86 | [libargs-x86-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-x86-linux.a) |
            | Linux | aarch64 (ARM64) | [libargs-aarch64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-aarch64-linux.a) |
            | macOS | x86_64 (Intel) | [libargs-x86_64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-x86_64-macos.a) |
            | macOS | aarch64 (Apple Silicon) | [libargs-aarch64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-aarch64-macos.a) |
            | Bare Metal | x86_64 | [libargs-x86_64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-x86_64-freestanding.a) |
            | Bare Metal | aarch64 | [libargs-aarch64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-aarch64-freestanding.a) |
            | Bare Metal | RISC-V 64 | [libargs-riscv64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-riscv64-freestanding.a) |
            | Bare Metal | ARM | [libargs-arm-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libargs-arm-freestanding.a) |

            ### üõ†Ô∏è Using Prebuilt Libraries

            1. Download the library for your platform.
            2. Place it in your project (e.g., in a `libs/` folder).
            3. Update your `build.zig`:

            ```zig
            // Assuming you placed the library in `libs/`
            exe.addLibraryPath(b.path("libs"));
            exe.linkSystemLibrary("args");
            ```
